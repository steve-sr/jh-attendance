{% extends "base.html" %}
{% block title %}Asistencia - JH{% endblock %}

{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
  <div>
    <h3 class="fw-bold mb-0">Asistencia</h3>
    <div class="text-muted">Registrar asistencia del servicio seleccionado</div>
  </div>
  <a class="btn btn-outline-primary" href="{{ url_for('select_service') }}">Cambiar servicio</a>
</div>

{% if not active %}
<div class="card p-4">
  <h5 class="fw-bold mb-1">No hay servicio seleccionado</h5>
  <p class="text-muted mb-3">Primero elegí un servicio activo para comenzar a registrar asistencia.</p>
  <a class="btn btn-primary" href="{{ url_for('select_service') }}">Elegir servicio activo</a>
</div>
{% else %}

<div class="row g-3">
  <div class="col-12 col-lg-5">
    <div class="card p-4">
      <div class="d-flex align-items-start justify-content-between gap-3">
        <div>
          <div class="text-muted small">Servicio</div>
          <h5 class="fw-bold mb-1">{{ active.title }}</h5>
          <div class="text-muted small">{{ active.service_date }} • {{ active.starts_at }}</div>
        </div>
        <span class="badge text-bg-success mt-1">Activo</span>
      </div>

      <hr>

      <h6 class="fw-bold mb-2">Registrar por cédula</h6>
      <form method="post" action="{{ url_for('attendance_register_active') }}">
        <div class="input-group">
          <input class="form-control mono-input" name="cedula" inputmode="numeric" placeholder="Ej: 5-0448-0768"
            data-mask="cedula" data-strip-digits="true" minlength="8" maxlength="11" required autofocus>

          <button class="btn btn-primary" type="submit">Registrar</button>
        </div>
        <div class="form-text">Tip: digitá la cédula y presioná Enter.</div>
      </form>

      <hr>

      <h6 class="fw-bold mb-2">Buscar por nombre o cédula</h6>
      <form method="get" action="{{ url_for('attendance_active') }}">
        <div class="input-group">
          <input class="form-control" name="q" placeholder="Ej: Juan o 1-234" value="{{ q }}">
          <button class="btn btn-outline-primary" type="submit">Buscar</button>
        </div>
      </form>

      {% if candidates and q %}
      <div class="mt-3">
        <div class="text-muted small mb-2">Resultados</div>
        <div class="list-group">
          {% for y in candidates %}
          <div class="list-group-item d-flex flex-wrap align-items-center justify-content-between gap-2">
            <div>
              <div class="fw-semibold">{{ y.full_name }}</div>
              <div class="text-muted small">{{ y.cedula }} • {{ y.phone }}</div>
            </div>
            <form method="post" action="{{ url_for('attendance_register_active') }}">
              <input type="hidden" name="cedula" value="{{ y.cedula }}">
              <button class="btn btn-sm btn-primary" type="submit">Registrar</button>
            </form>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <div class="col-12 col-lg-7">
    <div class="card p-3 p-md-4">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
        <h5 class="fw-bold mb-0">Lista del servicio</h5>
        <span class="badge badge-soft px-3 py-2">Registros: {{ rows|length }}</span>
      </div>

      {% if rows|length == 0 %}
      <p class="text-muted mb-0">Aún no hay asistencias registradas.</p>
      {% else %}
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead>
            <tr>
              <th>#</th>
              <th>Nombre</th>
              <th>Cédula</th>
              <th class="text-nowrap">Hora</th>
            </tr>
          </thead>
          <tbody>
            {% for att, y in rows %}
            <tr>
              <td class="text-muted">{{ loop.index }}</td>
              <td class="fw-semibold">{{ y.full_name }}</td>
              <td class="text-nowrap">{{ y.cedula }}</td>
              <td class="text-nowrap">{{ att.registered_at }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}
    </div>
  </div>
</div>

{% endif %}
{% endblock %}