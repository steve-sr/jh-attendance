{% extends "base.html" %}
{% block title %}Asistencia (Admin) - JH{% endblock %}

{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
  <div>
    <h3 class="fw-bold mb-0">Asistencia (Admin)</h3>
    <div class="text-muted">
      <span class="fw-semibold">{{ service.title }}</span> • {{ service.service_date }}
    </div>
  </div>

  <div class="d-flex flex-wrap gap-2">
    <a class="btn btn-outline-secondary" href="/admin/services">Volver</a>
    <a class="btn btn-dark" href="/admin/attendance/{{ service.id }}/export.csv">Exportar CSV</a>
  </div>
</div>

<div class="card p-3 p-md-4">
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
    <span class="badge badge-soft px-3 py-2">Registros: {{ rows|length }}</span>
  </div>

  {% if rows|length == 0 %}
    <p class="text-muted mb-0">Aún no hay asistencias registradas para este servicio.</p>
  {% else %}
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead>
          <tr>
            <th>#</th>
            <th class="text-nowrap">Cédula</th>
            <th>Nombre</th>
            <th class="text-nowrap">Contacto</th>
            <th>Barrio</th>
            <th class="text-nowrap">Registrado</th>
            <th class="text-nowrap">Por</th>
          </tr>
        </thead>
        <tbody>
          {% for att, y, u in rows %}
          <tr>
            <td class="text-muted">{{ loop.index }}</td>
            <td class="text-nowrap">{{ y.cedula|fmt_cedula }}</td>
            <td class="fw-semibold">{{ y.full_name }}</td>

            <td class="text-nowrap">
              <div class="d-flex align-items-center gap-2">
                <span>{{ y.phone|fmt_phone }}</span>
                {% set wa = y.phone|wa_link %}
                {% if wa %}
                  <a class="btn btn-sm btn-success" target="_blank" rel="noopener" href="{{ wa }}">
                    WhatsApp
                  </a>
                {% else %}
                  <span class="text-muted small">Sin tel.</span>
                {% endif %}
              </div>
            </td>

            <td>{{ y.barrio.name if y.barrio else "" }}</td>
            <td class="text-nowrap">{{ att.registered_at }}</td>
            <td class="text-nowrap">{{ u.username }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endif %}
</div>
{% endblock %}
