{% extends "base.html" %}
{% block title %}Usuarios - Admin{% endblock %}

{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
  <div>
    <h3 class="fw-bold mb-0">Usuarios</h3>
    <div class="text-muted">Crear admins/operativos, resetear contraseñas y desactivar accesos</div>
  </div>
  <a class="btn btn-outline-secondary" href="/admin/services">Volver</a>
</div>

<div class="row g-3">
  <div class="col-12 col-lg-5">
    <div class="card p-3 p-md-4">
      <h5 class="fw-bold mb-3">Crear usuario</h5>
      <form method="post" class="needs-validation" novalidate>
        <input type="hidden" name="action" value="create">

        <div class="mb-3">
          <label class="form-label">Usuario</label>
          <input class="form-control" name="username" required placeholder="Ej: maria">
          <div class="invalid-feedback">Obligatorio</div>
        </div>

        <div class="mb-3">
          <label class="form-label">Rol</label>
          <select class="form-select" name="role" required>
            <option value="OPERATIVE" selected>OPERATIVE</option>
            <option value="ADMIN">ADMIN</option>
          </select>
          <div class="invalid-feedback">Obligatorio</div>
        </div>

        <div class="mb-3">
          <label class="form-label">Contraseña</label>
          <input class="form-control" type="password" name="password" required placeholder="Mínimo 8 chars recomendado">
          <div class="invalid-feedback">Obligatorio</div>
        </div>

        <div class="d-grid">
          <button class="btn btn-primary" type="submit">Crear</button>
        </div>
      </form>
    </div>
  </div>

  <div class="col-12 col-lg-7">
    <div class="card p-3 p-md-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="fw-bold mb-0">Lista</h5>
        <span class="badge badge-soft px-3 py-2">Total: {{ users|length }}</span>
      </div>

      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead>
            <tr>
              <th>Usuario</th>
              <th>Rol</th>
              <th>Estado</th>
              <th class="text-end">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for u in users %}
            <tr>
              <td class="fw-semibold">{{ u.username }}</td>
              <td><span class="badge bg-dark">{{ u.role }}</span></td>
              <td>
                {% if u.is_active %}
                  <span class="badge bg-success">Activo</span>
                {% else %}
                  <span class="badge bg-secondary">Inactivo</span>
                {% endif %}
              </td>
              <td class="text-end">
                <div class="d-flex flex-wrap justify-content-end gap-2">

                  <!-- Toggle -->
                  <form method="post" style="display:inline">
                    <input type="hidden" name="action" value="toggle">
                    <input type="hidden" name="user_id" value="{{ u.id }}">
                    <button class="btn btn-sm btn-outline-secondary" type="submit">
                      {% if u.is_active %}Desactivar{% else %}Activar{% endif %}
                    </button>
                  </form>

                  <!-- Reset pass -->
                  <form method="post" class="d-flex gap-2" style="max-width: 260px;">
                    <input type="hidden" name="action" value="reset_password">
                    <input type="hidden" name="user_id" value="{{ u.id }}">
                    <input class="form-control form-control-sm" type="password" name="new_password" placeholder="Nueva clave" required>
                    <button class="btn btn-sm btn-outline-primary" type="submit">Reset</button>
                  </form>

                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="text-muted small mt-3">
        Tip: evitá compartir contraseñas por WhatsApp; mejor darlas en persona y pedir cambio inmediato.
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const forms = document.querySelectorAll('.needs-validation')
  Array.from(forms).forEach(form => {
    form.addEventListener('submit', event => {
      if (!form.checkValidity()) {
        event.preventDefault()
        event.stopPropagation()
      }
      form.classList.add('was-validated')
    }, false)
  })
})()
</script>
{% endblock %}
