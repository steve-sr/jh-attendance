{% extends "base.html" %}
{% block title %}JÃ³venes - JH{% endblock %}

{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
  <div>
    <h3 class="fw-bold mb-0">JÃ³venes</h3>
    <div class="text-muted">Registro y ediciÃ³n de asistentes</div>
  </div>
  <a class="btn btn-primary" href="/youth/new">+ Nuevo joven</a>
</div>

<div class="row g-2 align-items-center mb-3">
  <div class="col-12 col-md-7">
    <input id="liveSearch" class="form-control" type="text"
      placeholder="Buscar en vivo por nombre, cÃ©dula, telÃ©fono, barrio..."
      autocomplete="off">
  </div>

  <div class="col-12 col-md-auto">
    <button id="clearSearch" class="btn btn-outline-secondary w-100" type="button">
      Limpiar
    </button>
  </div>

  <div class="col-12 col-md text-md-end">
    <span class="badge text-bg-light border">
      Mostrando: <span id="visibleCount">0</span> / <span id="totalCount">0</span>
    </span>
  </div>
</div>

<div class="card p-3 p-md-4">
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
    <span class="badge badge-soft px-3 py-2">Total: {{ youth_rows|length }}</span>
  </div>

  {% if youth_rows|length == 0 %}
  <p class="text-muted mb-0">No hay jÃ³venes registrados todavÃ­a.</p>
  {% else %}
  <div class="table-responsive">
    <table id="youthTable" class="table table-hover align-middle mb-0">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>CÃ©dula</th>
          <th>TelÃ©fono</th>
          <th>Barrio</th>
          <th>Edad</th>

          {% if current_user.role == "ADMIN" %}
          <th>ðŸ”¥</th>
          {% endif %}

          <th>Acciones</th>
        </tr>
      </thead>

      <tbody id="youthTbody">
        {% for row in youth_rows %}
        {% set y = row[0] %}
        {% set b = row[1] %}
        {% set att_count = row[2] if current_user.role == "ADMIN" and row|length > 2 else 0 %}

        <tr>
          <td class="fw-semibold">
            {{ y.full_name }}
            {% if current_user.role == "ADMIN" %}
            <span class="badge text-bg-warning ms-2">ðŸ”¥ {{ att_count }}</span>
            {% endif %}
          </td>

          <td>{{ y.cedula|fmt_cedula }}</td>
          <td>{{ y.phone|fmt_phone }}</td>
          <td>{{ b.name if b else "" }}</td>
          <td>
            {# tu edad la calculÃ¡s como ya la tenÃ©s #}
            {{ y.birth_date }}
          </td>

          {% if current_user.role == "ADMIN" %}
          <td>
            <span class="badge text-bg-warning">ðŸ”¥ {{ att_count }}</span>
          </td>
          {% endif %}

          <td>
            <a class="btn btn-outline-primary btn-sm" href="/youth/{{y.cedula}}/edit">Editar</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>

    </table>
  </div>
  {% endif %}
</div>

<script>
(function () {
  const input = document.getElementById("liveSearch");
  const clearBtn = document.getElementById("clearSearch");
  const tbody = document.getElementById("youthTbody");
  const visibleCountEl = document.getElementById("visibleCount");
  const totalCountEl = document.getElementById("totalCount");

  if (!input || !tbody) return;

  const rows = Array.from(tbody.querySelectorAll("tr"));
  totalCountEl.textContent = rows.length;

  function normalize(str) {
    return (str || "")
      .toString()
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")  // quita acentos
      .trim();
  }

  function filter() {
    const q = normalize(input.value);
    let visible = 0;

    rows.forEach(tr => {
      // Busca en todo el texto visible de la fila
      const text = normalize(tr.innerText).replace(/-/g, "");
      const q2 = normalize(input.value).replace(/-/g, "");
      const show = !q2 || text.includes(q2);
      tr.style.display = show ? "" : "none";
      if (show) visible++;
    });

    visibleCountEl.textContent = visible;
  }

  // Debounce para no filtrar â€œa cada teclaâ€ demasiado
  let t = null;
  input.addEventListener("input", () => {
    clearTimeout(t);
    t = setTimeout(filter, 80);
  });

  clearBtn?.addEventListener("click", () => {
    input.value = "";
    input.focus();
    filter();
  });

  // Inicial
  visibleCountEl.textContent = rows.length;
})();
</script>


{% endblock %}