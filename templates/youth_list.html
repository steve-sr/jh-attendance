{% extends "base.html" %}
{% block title %}J√≥venes - JH{% endblock %}

{% block content %}
<div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
  <div>
    <h3 class="fw-bold mb-0">J√≥venes</h3>
    <div class="text-muted">Registro y edici√≥n de asistentes</div>
  </div>
  <a class="btn btn-primary" href="/youth/new">+ Nuevo joven</a>
</div>

<div class="row g-2 align-items-center mb-3">
  <div class="col-12 col-md-7">
    <input id="liveSearch" class="form-control" type="text"
      placeholder="Buscar en vivo por nombre, c√©dula, tel√©fono, barrio..." autocomplete="off">
  </div>

  <div class="col-12 col-md-auto">
    <button id="clearSearch" class="btn btn-outline-secondary w-100" type="button">
      Limpiar
    </button>
  </div>

  <div class="col-12 col-md text-md-end">
    <span class="badge text-bg-light border">
      Mostrando: <span id="visibleCount">0</span> / <span id="totalCount">0</span>
    </span>
  </div>
</div>

<div class="card p-3 p-md-4">
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
    <span class="badge badge-soft px-3 py-2">Total: {{ total }}</span>
  </div>

  {% if youth_rows|length == 0 %}
    <p class="text-muted mb-0">No hay j√≥venes registrados todav√≠a.</p>
  {% else %}

    <div class="table-responsive">
      <table id="youthTable" class="table table-hover align-middle mb-0">
        <thead>
          <tr>
            <th style="min-width: 220px;">Nombre</th>
            <th style="white-space:nowrap;">C√©dula</th>
            <th style="white-space:nowrap;">Tel√©fono</th>
            <th>Barrio</th>
            <th style="white-space:nowrap;">Edad</th>

            {% if current_user.role in ["ADMIN", "ROOT"] %}
              <th>Total</th>
              <th>Racha</th>
            {% endif %}


            <th style="white-space:nowrap;">Acciones</th>
          </tr>
        </thead>

        <tbody id="youthTbody">
          {% for row in youth_rows %}
            {% set y = row[0] %}
            {% set b = row[1] %}
            {% set att_count = row[2] if current_user.role in ["ADMIN", "ROOT"] and row|length > 2 else 0 %}
            {% set streak = streaks.get(y.cedula, 0) if current_user.role in ["ADMIN", "ROOT"] else 0 %}

            <tr>
              <td class="fw-semibold">{{ y.full_name }}</td>
              <td>{{ y.cedula|fmt_cedula }}</td>
              <td>{{ y.phone|fmt_phone }}</td>
              <td>{{ b.name if b else "" }}</td>

              <td>
                {% if y.birth_date %}
                  <span class="badge text-bg-light border">{{ y.birth_date|age }} a√±os</span>
                {% else %}
                  <span class="text-muted">‚Äî</span>
                {% endif %}
              </td>

              {% if current_user.role in ["ADMIN", "ROOT"] %}
                <td><span class="badge text-bg-light border">{{ att_count }}</span></td>
                <td>
                  {% if streak > 0 %}
                    <span class="badge text-bg-warning">üî• {{ streak }}</span>
                  {% else %}
                    <span class="text-muted">0</span>
                  {% endif %}
                </td>
              {% endif %}

              <td class="text-nowrap">
                <a class="btn btn-outline-primary btn-sm" href="/youth/{{ y.cedula }}/edit">Editar</a>

                {% if is_root_user() %}
                  <button type="button" class="btn btn-outline-danger btn-sm"
                    data-bs-toggle="modal"
                    data-bs-target="#deleteYouthModal"
                    data-cedula="{{ y.cedula }}"
                    data-name="{{ y.full_name }}">
                    Eliminar
                  </button>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>


      </table>
    </div>

  {% endif %}
</div>

{# -------------------------
   Modal eliminar (solo ROOT)
-------------------------- #}
{% if is_root_user() %}
<div class="modal fade" id="deleteYouthModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirmar eliminaci√≥n</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <div class="modal-body">
        <p class="mb-2">
          Vas a eliminar a:
          <b id="delName">‚Äî</b>
        </p>
        <div class="alert alert-danger mb-0">
          <b>Esto eliminar√° tambi√©n TODAS las asistencias</b> asociadas a este joven.
          Esta acci√≥n <b>no se puede deshacer</b>.
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          Cancelar
        </button>

        <form id="delForm" method="post" action="">
          <button type="submit" class="btn btn-danger">
            S√≠, eliminar
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
(function () {
  const modalEl = document.getElementById("deleteYouthModal");
  if (!modalEl) return;

  modalEl.addEventListener("show.bs.modal", function (event) {
    const btn = event.relatedTarget;
    const cedula = btn.getAttribute("data-cedula");
    const name = btn.getAttribute("data-name");

    document.getElementById("delName").textContent = name || "‚Äî";
    document.getElementById("delForm").action = `/youth/${cedula}/delete`;
  });
})();
</script>
{% endif %}

{# -------------------------
   B√∫squeda en vivo
-------------------------- #}
<script>
(function () {
  const input = document.getElementById("liveSearch");
  const clearBtn = document.getElementById("clearSearch");
  const tbody = document.getElementById("youthTbody");
  const visibleCountEl = document.getElementById("visibleCount");
  const totalCountEl = document.getElementById("totalCount");

  if (!input || !tbody) return;

  const rows = Array.from(tbody.querySelectorAll("tr"));
  totalCountEl.textContent = rows.length;

  function normalize(str) {
    return (str || "")
      .toString()
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .trim();
  }

  function filter() {
    const qRaw = normalize(input.value).replace(/-/g, "");
    let visible = 0;

    rows.forEach(tr => {
      const text = normalize(tr.innerText).replace(/-/g, "");
      const show = !qRaw || text.includes(qRaw);
      tr.style.display = show ? "" : "none";
      if (show) visible++;
    });

    visibleCountEl.textContent = visible;
  }

  let t = null;
  input.addEventListener("input", () => {
    clearTimeout(t);
    t = setTimeout(filter, 80);
  });

  clearBtn?.addEventListener("click", () => {
    input.value = "";
    input.focus();
    filter();
  });

  // Inicial
  visibleCountEl.textContent = rows.length;
})();
</script>
{% endblock %}